/*! websql.js | MIT license *///      (c) 2012 Stepan Riha
//      websql.js may be freely distributed under the MIT license.
//
// Module that wraps asynchronous WebSQL calls with deferred promises and provides SQL utility
// methods.
//
// Promises are **resolved** when asynchronous database callback is finished.
//
// Promises are **rejected** with an `Error` object that may contain one or more of the following:
//
// * `message`: Describing what failed
// * `exception`: Exception that was thrown
// * `sqlError`: Error returned by WebSQL
// * `sql`: statement that was executing
//
// ## Getting Started
//
// Websql can be loaded as
//
// * a `<script>` tag (creating a `websql` global)
// * an AMD module
//
// Websql can produce deferred promises using
//
// * [`when.js`](https://github.com/cujojs/when)
// * [`Q.js`](https://github.com/kriskowal/q)
// * [`jQuery's Deferred`](http://api.jquery.com/category/deferred-object/)
// * Other...
//
// ### To use in `<script>` tag
//
// The module will autodetect and use one of the supported promise providers
// if it's included in your HTML before `websql`:
//
//          <script src="path/to/when.js"></script>
//          <script src="path/to/websql.js"></script>
//          ...
//
// ### To use as an AMD module
//
// If a promise provider isn't loaded into the global scope, you need to use
// the `websql.config()` method to tell it which provider to use.
//
//          // Using a CommonJS Promisses/A implementation:
//          define(["websql", "when"], function(websql, when) {
//              websql.config({
//                  defer: when.defer
//              });
//              ...
//          })
//
//          // Using jQuery Deferred implementation:
//          define(["websql", "jquery"], function(websql, $) {
//              websql.config({
//                  defer: $.Deferred
//              });
//              ...
//          })
//
//
// ## Using the API
//
// Example:
//
//      var wsdb = websql("test");
//      wsdb.read("SELECT * FROM ...");
//          .then(function(resultSet) { ... });
//
(function(a,b){typeof define=="function"&&define.amd?define(b):a.websql=b()})(this,function(){function f(a,d,e,f){function n(a,d,e,f){j(c,"openDatabase",a,d,e,f),e||(e=a),d||(d=""),f||(f=2097152);var i=g();try{window.openDatabase?(C.db=m=window.openDatabase(a,d,e,f),m?i.resolve(this):i.reject(new Error("Failed to open database"))):(j(b,"WebSQL not implemented"),i.reject(new Error("WebSQL not implemented")))}catch(k){j(b,"Failed to open database "+a);var l=new Error("Failed to open database "+a);l.exception=k,i.reject(l)}return h(i)}function p(a,d,e){j(c,"openDatabase",m,a,d,e);var f=g();try{o(m)?m.changeVersion(a,d,e,function(a){j(b,a);var c=new Error("Failed to change version");c.sqlError=a,f.reject(c)},function(){j(c,"SUCCESS changeVersion"),f.resolve(this)}):l(f,"Database not specified (db='"+m+"')")}catch(i){j(b,i);var k=new Error("Failed changeVersion(db, '"+a+"', '"+d+"'')");k.exception=i,f.reject(k)}return h(f)}function r(){var a="SELECT name, type, sql FROM sqlite_master WHERE type in ('table') AND name NOT LIKE '?_?_%' ESCAPE '?'";return y(a,function(a){var b=[],c=a.rows;for(var d=0;d<c.length;d++)b.push(c.item(d));return b})}function t(a){var b="SELECT * FROM sqlite_master WHERE name = ?";return z(b,[a])}function u(){return p(m.version,"",function(a){var b="SELECT name FROM sqlite_master WHERE type in ('table') AND name NOT LIKE '?_?_%' ESCAPE '?'";a.executeSql(b,[],function(a,b){var c=b.rows;for(var d=0;d<c.length;d++){var e='DROP TABLE "'+c.item(d).name+'"';a.executeSql(e)}})})}function v(a){return A("transaction",a)}function w(a){return A("readTransaction",a)}function x(a,b,c){return B(v,a,b,c)}function y(a,b,c){return B(w,a,b,c)}function z(a){var b,c,d,e=1;return arguments[e]instanceof Array&&(b=arguments[e++]),arguments[e]instanceof Function&&(c=arguments[e++]),arguments[e]instanceof Object&&(d=arguments[e++]),i(y(a,b),function(a){var b;if(a.rows.length>1)return l(g(),new Error("Query returned "+a.rows.length+" rows"));if(a.rows.length==0)if(d)b=d;else{if(!c)return l(g(),new Error("Query returned 0 rows"));b=c()}else b=a.rows.item(0),c&&(b=c(b));return b})}function A(a,d){var e=g();j(c,a+": in");try{o(m)?m[a](function(f){try{d(f)}catch(g){var h={message:a+" callback threw an exception",exception:g};j(b,a+": exception",h),e.reject(h),j(c,a+": rejected")}},function(d){var f={message:"Failed executing "+a,sqlError:d};j(b,a+": error",f),e.reject(f),j(c,a+": rejected")},function(){j(c,a+": resolving"),e.resolve(this),j(c,a+": resolved")}):l(e,"Database not specified (db='"+m+"')")}catch(f){var i={message:"Failed calling "+a,exception:f};j(b,a+": exception",i),e.reject(i),j(c,a+": rejected")}return j(c,a+": out"),h(e)}function B(a,b,c,d){function g(a,b,c){a.executeSql(b,c||[],function(a,b){e.push(d?d(b):b)})}var e=[],f=this;typeof arguments[2]=="function"&&(d=arguments[2],c=undefined);var h;return i(a(function(a){var d;if(s(b)){h=!0;for(var d=0;d<b.length;d++){var e=b[d],f=q(e.args)?c:e.args;g(a,e.sql,f)}}else{h=s(c)&&s(c[0]);var i=h?c:[c];for(d=0;d<i.length;d++)g(a,b,i[d])}}),function(){return h?e:e[0]},function(a){return a.sql=b,a})}var k,m,C={openDatabase:n,changeVersion:p,getTables:r,tableExists:t,destroyDatabase:u,transaction:v,readTransaction:w,execute:x,read:y,readRow:z};if(o(a)){C.db=m=a;var D=g();k=h(D),D.resolve(this)}else a&&(k=n(a,d,e,f));return C}function j(a){if(a<=d&&e){var b=Array.prototype.slice.call(arguments,1);b.unshift("WebSQL:"),p(e.text)?e.text(b,"color: purple"):p(e.log)&&e.log(b.join(" "))}}function k(a){e=a}function l(a,c){return n(c)&&(c=new Error(c)),j(b,"ERROR: "+c.message||c.exception||c.sqlError),a.reject(c),h(a)}function m(a){return Object.prototype.toString.call(a)}function n(a){return m(a)==="[object String]"}function o(a){return m(a)==="[object Database]"}function p(a){return m(a)==="[object Function]"}function q(a){return a===void 0}function r(a){return a&&p(a.then)}function t(a,b,c,d){return new f(a,b,c,d)}"use strict";var a=0,b=1,c=2,d=a,e=console,g=function(){throw new Error("wbesql.defer not configured")},h=function(a){return p(a.pipe)?a.promise():a.promise},i=function(a,b,c){var d=g();return a.then(function(a){b&&(a=b(a)),r(a)?a.then(d.resolve,d.reject):d.resolve(a)},function(a){c&&(a=c(a)),r(a)?a.then(d.resolve,d.reject):d.reject(a)}),h(d)},s;return s=Array.isArray||function(a){return m(a)==="[object Array]"},t.config=function(a){p(a.defer)&&(g=a.defer),p(a.trace)&&(e=a.trace),q(a.logVerbosity)||(d=a.logVerbosity)},t.log={NONE:a,ERROR:b,DEBUG:c},window.when&&p(window.when.defer)?g=window.when.defer:window.Q&&p(window.Q.defer)?g=window.Q.defer:window.jQuery&&p(window.jQuery.Deferred)&&(g=window.jQuery.Deferred),t});